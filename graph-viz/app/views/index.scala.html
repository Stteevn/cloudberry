@()



@defining(play.core.PlayVersion.current) { version =>

    <html>

        <title>Reply Tweets Deck.GL</title>
        <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />

        <style type="text/css">
                #container {
                    width: 100%;
                    height: 100%;
                }

                #search {
                    width: 100%;
                    top: 10px;
                    position: absolute;
                }

                #info {
                    left: 0px;
                    display: block;
                    position: relative;
                    margin: 0px auto;
                    width: 50%;
                    padding: 10px;
                    border: none;
                    border-radius: 3px;
                    font-size: 12px;
                    text-align: center;
                    color: #222;
                    background: #fff;
                }
        </style>

        <body style="line-height: 0;">
            <div id="map" style="width: 100vw;
                height: 100vh"></div>
            <div id="search">
                <div class="row"></div>
                <div class="row">
                    <div class="col-sm-2"></div>
                    <input type="text" style="width: 40%"
                    class="form-control col-sm-4 ng-pristine ng-untouched ng-empty ng-invalid ng-invalid-required"
                    id="keyword-textbox" placeholder="Search keywords e.g hurricane">
                    <div class="col-sm-1"></div><span class="col-sm-1 input-group-btn">
                    <button type="submit" onclick="drawGraph()" class=" btn btn-primary" id="submit-button">
                        Submit</button></span>
                    <div class="col-sm-1"></div>
                    <button type="submit" onclick="newGraph()" class=" btn btn-primary" id="button">Bundling</button></span>
                </div>
            </div>
        </body>

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>
        <link href='assets/lib/bootstrap/css/bootstrap.css' rel='stylesheet' />

        <script src="/assets/javascripts/deckgl.min.js"></script>
        <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.50.0/mapbox-gl.js'></script>
        <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.50.0/mapbox-gl.css' rel='stylesheet' />

        <script>
                mapboxgl.accessToken = 'pk.eyJ1IjoiamVyZW15bGkiLCJhIjoiY2lrZ2U4MWI4MDA4bHVjajc1am1weTM2aSJ9.JHiBmawEKGsn3jiRK_d0Gw';
                const map = new mapboxgl.Map({
                    container: 'map',
                    style: 'mapbox://styles/mapbox/light-v9',
                    center: [-96.35, 39.5],
                    zoom: 3.7,
                    maxZoom: 5,
                    minZoom: 2
                });
                var query = "";

                var layer_id_list = [];
                var layer_data_amount = [];
                var cnt = 0;

                function add_id_2_list(id, num) {
                    layer_id_list.push(id);
                    layer_data_amount.push(num);
                    cnt++;
                }

                function remove_all_layers() {
                    for (var i = layer_id_list.length - 1; i >= 0 ; i--) {
                        map.removeLayer(layer_id_list[i]);

                    }
                    layer_id_list = [];
                    layer_data_amount = [];
                    cnt = 0;
                }

                function removeLayer() {
                    if (map.getLayer('layer') !== undefined) {
                        map.removeLayer('layer');
                    }
                    if (map.getLayer('layer2') !== undefined) {
                        map.removeLayer('layer2');
                    }
                }

                function drawGraph() {
                    // var fstart = performance.now();

                    // removeLayer();
                    if (cnt != 0) {
                        remove_all_layers();
                    }

                    query = document.getElementById("keyword-textbox").value;


                    var bounds = map.getBounds();
                    var ne = bounds.getNorthEast();
                    var sw = bounds.getSouthWest();
                    var ne_lng = ne.lng;
                    var ne_lat = ne.lat;
                    var sw_lng = sw.lng;
                    var sw_lat = sw.lat;

                    let socket = new WebSocket("ws://localhost:9000/echo");

                    socket.onopen = function (e) {
                        socket.send(query + ' ' + sw_lng + ' ' + ne_lng + ' ' + sw_lat + ' ' + ne_lat);
                    };

                    socket.onmessage = function (event) {
                        // var requestTimeStart = performance.now();
                        var meta = event.data;
                        var status = meta.charAt(0);
                        var date = meta.substring(1, 15);
                        var data = JSON.parse(meta.substring(15, meta.length));
                        console.log(data);
                        const layer = new MapboxLayer({
                            id: 'line' + cnt,
                            type: LineLayer,
                            data: data,
                            getSourcePosition: d => d.source,
                            getTargetPosition: d => d.target,
                            getStrokeWidth: d => Math.min(15, d.width * 2),
                            getColor: [177, 0, 38]
                        });
                        add_id_2_list('line' + cnt, data.length);
                        map.addLayer(layer);
                        if (status === 'N') {
                            socket.send(query + ' ' + sw_lng + ' ' + ne_lng + ' ' + sw_lat + ' ' + ne_lat + ' ' + date);
                        }
                    };

                    // var request = new XMLHttpRequest();
                    // request.open('GET', 'http://localhost:9000/replies?query=' + query + '&lowerLongitude=' + sw_lng + '&upperLongitude=' + ne_lng + '&lowerLatitude=' + sw_lat + '&upperLatitude=' + ne_lat, false);//for blocking
                    // request.send(null);
                    // if (request.status === 200) {
                    //     var requestTimeStart = performance.now();
                    //
                    //     var data = JSON.parse(request.responseText);
                    //     var parseTimeEnd = performance.now();
                    //     const myArcLayer = new MapboxLayer({
                    //         id: 'layer',
                    //         type: LineLayer,
                    //         data: data,
                    //         getSourcePosition: d => d.source,
                    //         getTargetPosition: d => d.target,
                    //         getStrokeWidth: d => Math.min(15, d.width * 2),
                    //         getColor: [177, 0, 38],
                    //     });
                    //
                    //     map.addLayer(myArcLayer);
                    //     var requestTimeEnd = performance.now();
                    //
                    // }
                    // var fend = performance.now();
                    // console.log("Time to render graph  " + (requestTimeEnd - parseTimeEnd) + " ms");
                    // console.log("Time to parse JSON " + (parseTimeEnd - requestTimeStart) + " ms");
                    // console.log("Total time of receiving data and finishing in deckGL is " + (requestTimeEnd-requestTimeStart) + " ms");
                    // console.log("Total time of drawGraph() is " + (fend-fstart) + " ms");
                };

                function newGraph() {
                    var fstart = performance.now();

                    // if (cnt != 0) {
                    //     remove_all_layers();
                    // }
                    if(map.getLayer('arc') != undefined){
                        map.removeLayer('arc');
                    }

                    query = document.getElementById("keyword-textbox").value;

                    var bounds = map.getBounds();
                    var ne = bounds.getNorthEast();
                    var sw = bounds.getSouthWest();
                    var ne_lng = ne.lng;
                    var ne_lat = ne.lat;
                    var sw_lng = sw.lng;
                    var sw_lat = sw.lat;

                    let socket = new WebSocket("ws://localhost:9000/bundle");
                    socket.onopen = function (e) {
                        socket.send(query + ' ' + sw_lng + ' ' + ne_lng + ' ' + sw_lat + ' ' + ne_lat);
                    };

                    socket.onmessage = function (event) {
                        if(map.getLayer('arc') != undefined){
                            map.removeLayer('arc');
                        }
                        var requestTimeStart = performance.now();
                        var meta = event.data;
                        console.log(meta);
                        var status = meta.charAt(0);
                        var date = meta.substring(1, 15);
                        var data = JSON.parse(meta.substring(15, meta.length));
                        console.log(data);
                        const layer = new MapboxLayer({
                            id: 'arc',
                            type: LineLayer,
                            data: data,
                            getSourcePosition: d => d.from,
                            getTargetPosition: d => d.to,
                            getStrokeWidth: d => Math.min(15, Math.ceil(Math.pow(d.width, 1 / 3))),
                            getColor: [177, 0, 38]
                        });
                        // add_id_2_list('arc' + cnt, data.length);
                        map.addLayer(layer);
                        if (status === 'N') {
                            socket.send(query + ' ' + sw_lng + ' ' + ne_lng + ' ' + sw_lat + ' ' + ne_lat + ' ' + date);
                        }
                    };
                    // var request = new XMLHttpRequest();
                    // request.open('GET', 'http://localhost:9000/query?query=' + query + '&lowerLongitude=' + sw_lng + '&upperLongitude=' + ne_lng + '&lowerLatitude=' + sw_lat + '&upperLatitude=' + ne_lat, false);//for blocking
                    // request.send(null);
                    // if (request.status === 200) {
                    //     var requestTimeStart = performance.now();
                    //     var data = JSON.parse(request.responseText);
                    //     console.log(data);
                    //     const layer = new MapboxLayer({
                    //         id: 'layer2',
                    //         type: LineLayer,
                    //         data: data,
                    //         getSourcePosition: d => d.from,
                    //         getTargetPosition: d => d.to,
                    //         getStrokeWidth: d => Math.min(15, Math.ceil(Math.pow(d.width, 1/3))),
                    //         getColor: [177, 0, 38]
                    //     });
                    //     map.addLayer(layer);
                    // }
                }
        </script>

    </html>

}